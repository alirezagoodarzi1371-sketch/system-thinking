<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¨Ø§Ø²ÛŒ ØªÙÚ©Ø± Ø³ÛŒØ³ØªÙ…ÛŒ â€“ Ù…Ø¯ÛŒØ±Ø¹Ø§Ù…Ù„ (Player Only)</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{ --bg:#0b1020; --bg2:#0f172a; --muted:#9fb0c7; --text:#e5edf7; --accent:#7dd3fc; --accent2:#a78bfa; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:"Vazirmatn",system-ui,sans-serif;margin:0;color:var(--text);
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(124,58,237,.25), transparent 60%),
        radial-gradient(1200px 800px at -10% 100%, rgba(14,165,233,.25), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }
    .wrap{max-width:1200px;margin:0 auto;padding:28px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:grid;place-items:center;font-weight:900;color:#0b1020}
    h1{font-size:22px;margin:0}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:16px}
    .cols{grid-template-columns:repeat(auto-fit,minmax(300px,1fr));}
    .card{
      position:relative;
      background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;padding:18px;backdrop-filter: blur(6px);
      box-shadow:0 12px 30px rgba(0,0,0,.25)
    }
    h2{font-size:18px;margin:4px 0 10px}
    label{display:block;font-size:13px;margin:10px 0 6px;color:var(--muted)}
    input,button{width:100%;background:#0a1225;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
    input[type="range"]{padding:0}
    .row{display:flex;align-items:center;gap:8px}
    .row > input[type="number"]{width:110px}
    .kpi{display:grid;grid-template-columns:repeat(3,minmax(120px,1fr));gap:10px}
    .tile{background:#0a1225;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px}
    .tile .ttl{font-size:12px;color:var(--muted)} .tile .val{font-weight:700;font-size:18px}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .btn{cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;color:#081022;font-weight:800}
    .warn{color:#facc15}.bad{color:#fb7185}.good{color:#34d399}
    .table{width:100%;border-collapse:collapse;margin-top:8px;font-size:12px}
    .table th,.table td{border-bottom:1px dashed rgba(255,255,255,.08);padding:6px;text-align:center}
    .sep{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .footer{opacity:.75;font-size:12px;text-align:center;margin-top:18px}
    a{color:#93c5fd}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">ğŸ§ </div>
        <div>
          <h1>Ø¨Ø§Ø²ÛŒ ØªÙÚ©Ø± Ø³ÛŒØ³ØªÙ…ÛŒ: Ù…Ø¯ÛŒØ±Ø¹Ø§Ù…Ù„ (Player Only)</h1>
          <div class="muted">Ù‡Ø± Ù…Ø§Ù‡ Ø³Ù‡ ØªØµÙ…ÛŒÙ… Ø¨Ú¯ÛŒØ±Ø› Ù¾ÛŒØ§Ù…Ø¯Ù‡Ø§ Ø±Ø§ Ø¯Ø± Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø± Ø¨Ø¨ÛŒÙ†.</div>
        </div>
      </div>
      <div>
        <button id="dlCsv" class="btn" type="button">Ø¯Ø§Ù†Ù„ÙˆØ¯ CSV Ù†ØªØ§ÛŒØ¬</button>
      </div>
    </header>

    <div class="grid cols">
      <div class="card">
        <h2>ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡ <span id="mLabel">1</span> / 12</h2>
        <label>ØªØ¹Ø¯Ø§Ø¯ ØªÛŒÙ…â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ (N) <span class="muted">[1..8]</span></label>
        <input id="N" type="number" min="1" max="8" step="1" value="3" />

        <label>Train% â€“ Ø¯Ø±ØµØ¯ Ø²Ù…Ø§Ù† Ø¢Ù…ÙˆØ²Ø´ Ú©Ù„ ØªÛŒÙ…â€ŒÙ‡Ø§ (0..1)</label>
        <div class="row">
          <input id="TrainPct" type="range" min="0" max="1" step="0.05" value="0.2" />
          <input id="TrainPctBox" type="number" min="0" max="1" step="0.05" value="0.2" />
        </div>

        <label>Ws â€“ Ø³Ù‡Ù… Ø§ÙˆÙ„ÙˆÛŒØª Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª (0..1)</label>
        <div class="row">
          <input id="Ws" type="range" min="0" max="1" step="0.05" value="0.6" />
          <input id="WsBox" type="number" min="0" max="1" step="0.05" value="0.6" />
        </div>

        <div class="btns">
          <button class="btn primary" id="nextBtn" type="button">Ø«Ø¨Øª Ùˆ Ø±ÙØªÙ† Ø¨Ù‡ Ù…Ø§Ù‡ Ø¨Ø¹Ø¯ â–¶ï¸</button>
          <button class="btn" id="autoBtn" type="button">Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªØ§ Ù¾Ø§ÛŒØ§Ù† â©</button>
          <button class="btn" id="resetBtn" type="button">Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ â™»ï¸</button>
        </div>
        <p id="alerts" class="muted" style="margin-top:6px"></p>
      </div>

      <div class="card">
        <h2>Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø±</h2>
        <div class="kpi">
          <div class="tile"><div class="ttl">Ø³ÙˆØ¯ Ù…Ø§Ù‡</div><div class="val" id="kProfit">â€“</div></div>
          <div class="tile"><div class="ttl">Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ</div><div class="val" id="kCash">â€“</div></div>
          <div class="tile"><div class="ttl">Backlog</div><div class="val" id="kBacklog">â€“</div></div>
          <div class="tile"><div class="ttl">Ø±Ø¶Ø§ÛŒØª Ù…Ø´ØªØ±ÛŒ C</div><div class="val" id="kC">â€“</div></div>
          <div class="tile"><div class="ttl">Throughput</div><div class="val" id="kTh">â€“</div></div>
          <div class="tile"><div class="ttl">Rework</div><div class="val" id="kRw">â€“</div></div>
        </div>
        <div class="sep"></div>
        <canvas id="chart" height="180"></canvas>
        <div class="sep"></div>
        <table class="table" id="logTbl">
          <thead>
            <tr>
              <th>Ù…Ø§Ù‡</th><th>N</th><th>Train%</th><th>Ws</th><th>Th</th><th>Rw</th><th>Backlog</th><th>Profit</th><th>Cash</th><th>C</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="footer">Â© System Thinking Game â€¢ Ù†Ø³Ø®Ù‡ Ù…Ø®ØµÙˆØµ Ø¨Ø§Ø²ÛŒÚ©Ù† (Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ Ù‚ÙÙ„ Ù‡Ø³ØªÙ†Ø¯)</div>
  </div>

<script>
function $(id){ return document.getElementById(id); }
function toNum(x, f=0){ const v=parseFloat(x); return Number.isFinite(v)?v:f; }
function toInt(x, f=0){ const v=parseInt(x,10); return Number.isFinite(v)?v:f; }
function nf(x){ return Number(x).toFixed(2); }
function clamp(x,a,b){ return Math.min(Math.max(x,a),b); }
function clamp01(x){ return clamp(x,0,1); }

// Ø«Ø§Ø¨Øªâ€ŒÙ‡Ø§
const PCONST = {
  Backlog_0:300, Cash_0:200, H_0:0.6, F_0:0.2, C_0:0.5,
  NewWork:20, TargetBacklog:200,
  Pmin:2.0, gammaH:1.2, gammaS:0.5, gammaF:0.8,
  phi_coord:0.02, phi_onb:0.3, ccoord:0.05,
  cteam:5, crework:1.5, alpha:0.15, deltaH:0.03, deltaF:0.1, deltaC:0.03,
  eta1:0.1, eta2:0.15, kappa:0.7,
  rho0:0.15, rhoS:0.4, rhoH:0.3,
  pi_s:1.4, pi_l:1.1, psi:0.2
};

const months=12; let s={}; let m=1; let hist=[]; let lastN=null,lastWs=null; let chart;

function init(){
  const p=PCONST;
  s={p,Backlog:p.Backlog_0,Cash:p.Cash_0,H:p.H_0,F:p.F_0,C:p.C_0,S:p.kappa*p.Backlog_0/Math.max(1,p.TargetBacklog)};
  m=1;hist=[];lastN=null;lastWs=null;
  $("mLabel").textContent=m;
  $("logTbl").querySelector("tbody").innerHTML="";
  updateKPIs(null);$("alerts").textContent="";
  chart.data.labels=[];chart.data.datasets.forEach(ds=>ds.data=[]);chart.update();
}

function stepOnce(){
  if(m>months)return;
  const p=s.p;
  const N=clamp(toInt($("N").value,3),1,8);
  const TrainPct=clamp(toNum($("TrainPct").value,toNum($("TrainPctBox").value,0)),0,1);
  const Ws=clamp(toNum($("Ws").value,toNum($("WsBox").value,0.6)),0,1);
  $("TrainPctBox").value=TrainPct;$("WsBox").value=Ws;

  const Wl=1-Ws,Train_TM=TrainPct*N,AvailFrac=Math.max(0,1-Train_TM/Math.max(0.0001,N));
  const H_prev=s.H,F_prev=s.F,S_prev=s.S;
  const P_core=p.Pmin+p.gammaH*H_prev,Denom=1+p.gammaS*S_prev+p.gammaF*F_prev;
  const P=(P_core/Denom)*AvailFrac;
  const N_prev=(lastN==null?N:lastN),N_up=Math.max(0,N-N_prev);
  const EffTeams=Math.max(0,N-(p.phi_coord*N*(N-1))-(p.phi_onb*N_up));
  const Ws_prev=(lastWs==null?Ws:lastWs),PriorityEff=1-p.psi*Math.abs(Ws-Ws_prev);
  const GrossProd=EffTeams*P*PriorityEff;
  const Q=Math.min(0.9,0.3+0.6*H_prev);
  const StressEff=1+p.rhoS*S_prev;
  const ReworkRate=Math.min(0.9,Math.max(0,p.rho0*StressEff*(1-Q+p.rhoH*(1-H_prev))));
  const Rework=ReworkRate*GrossProd;
  const Throughput=Math.max(0,GrossProd-Rework);
  const Backlog=s.Backlog-Throughput+p.NewWork;
  const S_next=p.kappa*Backlog/Math.max(1,p.TargetBacklog);
  const F=F_prev+p.eta1*(N?(GrossProd/N):0)-p.eta2*(N?(Train_TM/N):0)-p.deltaF*F_prev;
  const H=H_prev+p.alpha*Train_TM-p.deltaH*H_prev;
  const Revenue=(p.pi_s*Ws+p.pi_l*Wl)*Throughput,CoordCost=p.ccoord*N*(N-1);
  const Cost=p.cteam*N+Train_TM+CoordCost+p.crework*Rework,Profit=Revenue-Cost;
  const Cash=s.Cash+Profit;
  const OnTimeRatio=GrossProd===0?0:(Throughput/Math.max(1,Throughput+Rework));
  const C=clamp01(s.C+0.2*OnTimeRatio-0.1*(GrossProd===0?0:(Rework/Math.max(1,GrossProd)))-p.deltaC*s.C);
  s={p,Backlog,Cash,H,F,C,S:S_next};lastN=N;lastWs=Ws;
  const row={m,N,TrainPct,Ws,Throughput,Rework,Backlog,Profit,Cash,C};
  hist.push(row);addLogRow(row);updateKPIs(row);updateChart();
  const msgs=[];if(S_next>1.2)msgs.push('âš ï¸ ÙØ´Ø§Ø± Ø¨Ø§Ù„Ø§Ø³Øªâ€”Ø±ÛŒØ³Ú© Ø®Ø·Ø§ Ùˆ Ø¨Ø§Ø²Ú©Ø§Ø±ÛŒ Ø¨Ø§Ù„Ø§ Ù…ÛŒâ€ŒØ±ÙˆØ¯.');if(TrainPct<0.05&&H_prev<0.7)msgs.push('âš ï¸ Ø¢Ù…ÙˆØ²Ø´ Ú©Ù… Ùˆ Ù‚Ø§Ø¨Ù„ÛŒØª Ù¾Ø§ÛŒÛŒÙ†');if(N_up>0&&m>8)msgs.push('âš ï¸ Ø§ÙØ²ÙˆØ¯Ù† ØªÛŒÙ… Ø¯ÛŒØ±Ù‡Ù†Ú¯Ø§Ù… Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ù…Ú© Ù†Ú©Ù†Ø¯');if(Cash<0)msgs.push('â›”ï¸ ÙˆØ±Ø´Ú©Ø³ØªÚ¯ÛŒ');
  $("alerts").innerHTML=msgs.map(x=>`<div class="${x.includes('â›”ï¸')?'bad':'warn'}">${x}</div>`).join('');
  m++;$("mLabel").textContent=Math.min(m,months);
}

function addLogRow(r){
  const tr=document.createElement("tr");
  tr.innerHTML=
    `<td>${r.m}</td><td>${r.N}</td><td>${r.TrainPct.toFixed(2)}</td><td>${r.Ws.toFixed(2)}</td>`+
    `<td>${r.Throughput.toFixed(2)}</td><td>${r.Rework.toFixed(2)}</td><td>${r.Backlog.toFixed(2)}</td>`+
    `<td>${r.Profit.toFixed(2)}</td><td>${r.Cash.toFixed(2)}</td><td>${r.C.toFixed(2)}</td>`;
  $("logTbl").querySelector("tbody").appendChild(tr);
}

function updateKPIs(k){
  $("kProfit").textContent=k?nf(k.Profit):"â€“";
  $("kCash").textContent=k?nf(k.Cash):"â€“";
  $("kBacklog").textContent=k?nf(k.Backlog):"â€“";
  $("kC").textContent=k?k.C.toFixed(2):"â€“";
  $("kTh").textContent=k?nf(k.Throughput):"â€“";
  $("kRw").textContent=k?nf(k.Rework):"â€“";
}

// CSV
function downloadCsv(){
  if(hist.length===0){alert("Ø§ÙˆÙ„ Ú†Ù†Ø¯ Ù…Ø§Ù‡ Ø¨Ø§Ø²ÛŒ Ú©Ù† Ø¨Ø¹Ø¯ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†.");return;}
  const headers=['Month','N','Train%','Ws','Throughput','Rework','Backlog','Profit','Cash','C'];
  const rows=hist.map(r=>[r.m,r.N,r.TrainPct,r.Ws,r.Throughput,r.Rework,r.Backlog,r.Profit,r.Cash,r.C]);
  const csv=[headers.join(','),...rows.map(a=>a.join(','))].join('
');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='system-thinking-ceo-results.csv'; a.click();
  URL.revokeObjectURL(url);
}

// Chart: Cash, Backlog, Throughput, C (right axis), Rework
function makeChart(){
  const ctx=$("chart");
  chart=new Chart(ctx,{
    type:'line',
    data:{labels:[],datasets:[
      {label:'Cash',data:[],tension:.35},
      {label:'Backlog',data:[],tension:.35},
      {label:'Throughput',data:[],tension:.35},
      {label:'C (Satisfaction)',data:[],tension:.35,yAxisID:'y1'},
      {label:'Rework',data:[],tension:.35}
    ]},
    options:{
      interaction:{mode:'index',intersect:false},
      plugins:{legend:{labels:{font:{family:'Vazirmatn'}}}},
      scales:{
        x:{ticks:{font:{family:'Vazirmatn'}},grid:{color:'rgba(255,255,255,.06)'}},
        y:{grid:{color:'rgba(255,255,255,.06)'}},
        y1:{position:'left',grid:{drawOnChartArea:false},suggestedMin:0,suggestedMax:1}
      }
    }
  });
}

function updateChart(){
  const r=hist[hist.length-1];
  chart.data.labels.push('M'+r.m);
  chart.data.datasets[0].data.push(+r.Cash.toFixed(2));
  chart.data.datasets[1].data.push(+r.Backlog.toFixed(2));
  chart.data.datasets[2].data.push(+r.Throughput.toFixed(2));
  chart.data.datasets[3].data.push(+r.C.toFixed(3));
  chart.data.datasets[4].data.push(+r.Rework.toFixed(2));
  chart.update();
}

document.addEventListener("DOMContentLoaded", () => {
  $("TrainPct").addEventListener("input", e => $("TrainPctBox").value = e.target.value);
  $("TrainPctBox").addEventListener("input", e => $("TrainPct").value = e.target.value);
  $("Ws").addEventListener("input", e => $("WsBox").value = e.target.value);
  $("WsBox").addEventListener("input", e => $("Ws").value = e.target.value);

  $("nextBtn").addEventListener("click", () => { if (m <= months && Number(s.Cash) >= 0) stepOnce(); });
  $("autoBtn").addEventListener("click", () => { while (m <= months && Number(s.Cash) >= 0) stepOnce(); });
  $("resetBtn").addEventListener("click", init);
  $("dlCsv").addEventListener("click", downloadCsv);

  const u=new URL(location.href).searchParams;
  if(u.get("N")) $("N").value=+u.get("N");
  if(u.get("Train")) { $("TrainPct").value = $("TrainPctBox").value = +u.get("Train"); }
  if(u.get("Ws")) { $("Ws").value = $("WsBox").value = +u.get("Ws"); }

  makeChart();
  init();
});
</script>
</body>
</html>
